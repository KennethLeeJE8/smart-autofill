<!--
 Copyright 2022 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" />
    <meta name="description" content="User Information Form" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />
    <title>User Information Form</title>

    <link rel="stylesheet" href="https://unpkg.com/open-props" />
    <link rel="stylesheet" href="https://unpkg.com/open-props/normalize.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/open-props/buttons.min.css" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ™‚</text></svg>"
    />
    <link rel="stylesheet" href="../demo.css" />
    <script src="known-customer.js"></script>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        padding: 30px;
        max-width: 100%;
        margin: 0 auto;
        box-sizing: border-box;
        background-color: #222;
        color: #fff;
      }
      
      html {
        background-color: #222;
      }
      
      .form-container {
        width: 100%;
        max-width: 100%;
        background-color: #333;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      .form-group {
        margin-bottom: 25px;
      }
      
      h4 {
        font-size: 24px;
        margin-bottom: 25px;
        color: #fff;
      }
      
      label {
        display: block;
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 500;
        color: #fff;
      }
      
      input, textarea {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #555;
        border-radius: 6px;
        box-sizing: border-box;
        background-color: #222;
        color: #fff;
      }
      
      textarea {
        resize: vertical;
        min-height: 80px;
      }
      
      button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 15px 25px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
      }
      
      button:hover {
        background-color: #3367d6;
      }
      
      .success-message {
        display: none;
        background-color: #34a853;
        color: #fff;
        padding: 15px;
        border-radius: 6px;
        margin-top: 25px;
        text-align: center;
        font-size: 16px;
      }
      
      #knownUserContainer {
        display: none;
        background-color: #333;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      .user-greeting {
        margin-bottom: 25px;
      }
      
      .user-greeting p {
        margin-bottom: 12px;
        font-size: 16px;
      }
      
      .user-profile {
        background-color: #444;
        padding: 25px;
        border-radius: 8px;
        margin-top: 25px;
        border: 1px solid #555;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      
      .profile-field {
        margin-bottom: 18px;
        padding-bottom: 18px;
        border-bottom: 1px solid #555;
      }
      
      .field-label {
        font-weight: bold;
        margin-right: 12px;
        min-width: 90px;
        display: inline-block;
      }
      
      .field-value {
        color: #ddd;
      }
      
      .view-data-button, .edit-button {
        display: inline-block;
        background-color: #4285f4;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        margin-top: 15px;
        margin-right: 15px;
        border: none;
        cursor: pointer;
      }
      
      .edit-button {
        background-color: #34a853;
      }
      
      input:focus, textarea:focus {
        outline: none;
        border-color: #4285f4;
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.3);
      }
      
      /* Better responsiveness for mobile */
      @media (max-width: 480px) {
        body {
          padding: 15px;
        }
        
        .form-group {
          margin-bottom: 15px;
        }
        
        label {
          font-size: 16px;
          margin-bottom: 5px;
        }
        
        input, textarea {
          padding: 10px;
        }
        
        button {
          width: 100%;
        }
      }
      
      /* Ensure content doesn't get cut off */
      html, body {
        overflow-x: hidden;
        width: 100%;
        height: auto;
        min-height: 100%;
      }
      
      ::placeholder {
        color: #aaa;
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <div id="knownUserContainer" style="display: none;">
      <h4>Welcome Back!</h4>
      <div class="user-greeting">
        <p>Hello <span id="userName">User</span>!</p>
        <p>We recognize you! Your information is already saved.</p>
      </div>
      
      <div class="user-profile">
        <div class="profile-field">
          <span class="field-label">Name:</span>
          <span id="fullName" class="field-value">-</span>
        </div>
        <div class="profile-field">
          <span class="field-label">Email:</span>
          <span id="userEmail" class="field-value">-</span>
        </div>
        <div class="profile-field">
          <span class="field-label">Location:</span>
          <span id="userLocation" class="field-value">-</span>
        </div>
        
        <button id="editInfoBtn" class="edit-button">Edit Information</button>
        <button id="viewDataBtn" class="view-data-button" onclick="window.parent.location.href = '../payment-provider'">View All Your Data</button>
      </div>
    </div>
    
    <div id="formContainer" class="form-container">
      <h4>Please Fill Out Your Information</h4>
      <form id="userInfoForm">
        <div class="form-group">
          <label for="firstName">First Name</label>
          <input type="text" id="firstName" name="firstName" value="Kenneth" required>
        </div>
        
        <div class="form-group">
          <label for="lastName">Last Name</label>
          <input type="text" id="lastName" name="lastName" value="Lee" required>
        </div>
        
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required>
        </div>
        
        <div class="form-group">
          <label for="phone">Phone</label>
          <input type="tel" id="phone" name="phone">
        </div>
        
        <div class="form-group">
          <label for="about">About Me</label>
          <textarea id="about" name="about">Endlessly curious and a firm believer in "hard work always pays off"</textarea>
        </div>
        
        <div class="form-group">
          <label for="company">Company</label>
          <input type="text" id="company" name="company">
        </div>
        
        <div class="form-group">
          <label for="location">Location</label>
          <input type="text" id="location" name="location" value="Cambridge, Massachusetts, United States">
        </div>
        
        <div class="form-group">
          <label for="website">Website</label>
          <input type="url" id="website" name="website">
        </div>
        
        <button type="submit">Submit</button>
      </form>
      
      <div id="successMessage" class="success-message">
        Form data successfully saved! Your information has been securely stored.
      </div>
    </div>
    
    <script>
      document.addEventListener('DOMContentLoaded', async function() {
        // Check if user is already known
        if (window.sharedStorage) {
          try {
            // Check if we're in a fenced frame context where sharedStorage can be used
            if (window.self !== window.top) {
              const knownValue = await window.sharedStorage.get('known-customer');
              
              if (knownValue === '1') {
                // Get user information from shared storage
                const firstName = await window.sharedStorage.get('firstName') || '';
                const lastName = await window.sharedStorage.get('lastName') || '';
                const email = await window.sharedStorage.get('email') || '';
                const phone = await window.sharedStorage.get('phone') || '';
                const about = await window.sharedStorage.get('about') || '';
                const company = await window.sharedStorage.get('company') || '';
                const location = await window.sharedStorage.get('location') || '';
                const website = await window.sharedStorage.get('website') || '';
                
                // Check if all required fields have values
                const hasRequiredFields = firstName && lastName && email;
                
                if (hasRequiredFields) {
                  // Update the UI with user information
                  document.getElementById('userName').textContent = firstName;
                  document.getElementById('fullName').textContent = firstName + ' ' + lastName;
                  document.getElementById('userEmail').textContent = email || 'Not provided';
                  document.getElementById('userLocation').textContent = location || 'Not provided';
                  
                  // Show the known user container, hide form
                  document.getElementById('knownUserContainer').style.display = 'block';
                  document.getElementById('formContainer').style.display = 'none';
                  
                  // Notify parent about known customer state
                  if (window.parent) {
                    window.parent.postMessage({
                      type: 'knownCustomerState',
                      isKnown: true,
                      userData: { firstName, lastName, email, phone, about, company, location, website }
                    }, '*');
                  }
                }
                
                // Prefill form with existing data regardless of whether we show the known user container
                const fields = ['firstName', 'lastName', 'email', 'phone', 'about', 'company', 'location', 'website'];
                for (const field of fields) {
                  const value = await window.sharedStorage.get(field);
                  if (value && document.getElementById(field)) {
                    document.getElementById(field).value = value;
                  }
                }
              } else {
                // Notify parent about unknown customer state
                if (window.parent) {
                  window.parent.postMessage({
                    type: 'knownCustomerState',
                    isKnown: false
                  }, '*');
                }
              }
            } else {
              console.log('Not in a fenced frame context, cannot access SharedStorage');
            }
          } catch (error) {
            console.log('Error checking known-customer status:', error);
          }
        }
      });
      
      document.getElementById('userInfoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!window.sharedStorage) {
          alert('Shared Storage is not available in your browser.');
          return;
        }
        
        // Get form values
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const about = document.getElementById('about').value;
        const company = document.getElementById('company').value;
        const location = document.getElementById('location').value;
        const website = document.getElementById('website').value;
        
        // Save each field to shared storage
        await window.sharedStorage.set('firstName', firstName);
        await window.sharedStorage.set('lastName', lastName);
        await window.sharedStorage.set('email', email);
        await window.sharedStorage.set('phone', phone);
        await window.sharedStorage.set('about', about);
        await window.sharedStorage.set('company', company);
        await window.sharedStorage.set('location', location);
        await window.sharedStorage.set('website', website);
        
        // Set known-customer status to 1 (known)
        await window.sharedStorage.set('known-customer', '1');
        
        // Show success message
        document.getElementById('successMessage').style.display = 'block';
        
        // Send data to localhost:4437
        try {
          const formData = {
            firstName, lastName, email, phone, about, company, location, website
          };
          
          await fetch('https://localhost:4437', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          });
          
          console.log('Data successfully sent to localhost:4437');
        } catch (error) {
          console.error('Error sending data to localhost:4437:', error);
        }
        
        // Update UI after 2 seconds
        setTimeout(() => {
          document.getElementById('successMessage').style.display = 'none';
          
          // Update known user container with new data
          document.getElementById('userName').textContent = firstName;
          document.getElementById('fullName').textContent = firstName + ' ' + lastName;
          document.getElementById('userEmail').textContent = email || 'Not provided';
          document.getElementById('userLocation').textContent = location || 'Not provided';
          
          // Show known user container, hide form
          document.getElementById('knownUserContainer').style.display = 'block';
          document.getElementById('formContainer').style.display = 'none';
          
          // Notify parent about known customer state
          if (window.parent) {
            window.parent.postMessage({
              type: 'knownCustomerState',
              isKnown: true
            }, '*');
          }
        }, 2000);
      });
      
      // Handle Edit button click
      document.getElementById('editInfoBtn').addEventListener('click', function() {
        document.getElementById('knownUserContainer').style.display = 'none';
        document.getElementById('formContainer').style.display = 'block';
      });
    </script>
  </body>
</html>
